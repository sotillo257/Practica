<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planning Poker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background:
                linear-gradient(135deg, rgba(102, 126, 234, 0.9) 0%, rgba(118, 75, 162, 0.9) 100%),
                radial-gradient(ellipse at top left, rgba(255, 255, 255, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(0, 0, 0, 0.1) 0%, transparent 50%);
            background-attachment: fixed;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 50%, rgba(255, 255, 255, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255, 255, 255, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            background:
                linear-gradient(145deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 249, 255, 0.95) 100%);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 40px;
            box-shadow:
                0 30px 80px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            max-width: 1200px;
            width: 100%;
            position: relative;
            z-index: 1;
        }

        h1 {
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 30px;
            font-size: 2.8em;
            font-weight: 800;
            text-shadow: 0 5px 20px rgba(102, 126, 234, 0.2);
            letter-spacing: -1px;
            position: relative;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 4px;
            background: linear-gradient(90deg, transparent, #667eea, transparent);
            border-radius: 2px;
        }

        .setup-screen {
            display: flex;
            flex-direction: column;
            gap: 20px;
            max-width: 400px;
            margin: 0 auto;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            color: #333;
        }

        input {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 14px 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow:
                0 6px 20px rgba(102, 126, 234, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.3),
                transparent
            );
            transition: left 0.5s;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow:
                0 10px 30px rgba(102, 126, 234, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        button:hover::before {
            left: 100%;
        }

        button:active {
            transform: translateY(-1px);
            box-shadow:
                0 5px 15px rgba(102, 126, 234, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        button:disabled {
            background: linear-gradient(135deg, #ccc 0%, #aaa 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        button:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .game-screen {
            display: none;
        }

        .game-info {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 12px;
        }

        .game-info h2 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 15px;
            margin: 30px 0;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .card {
            aspect-ratio: 2/3;
            background:
                linear-gradient(145deg, #ffffff 0%, #f8f9ff 100%);
            border: 3px solid transparent;
            background-clip: padding-box;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: 800;
            color: #667eea;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            box-shadow:
                0 4px 15px rgba(102, 126, 234, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 16px;
            z-index: -1;
            opacity: 0.5;
        }

        .card::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(255, 255, 255, 0.4),
                transparent
            );
            transition: left 0.5s;
        }

        .card:hover {
            transform: translateY(-15px) rotate(2deg);
            box-shadow:
                0 15px 40px rgba(102, 126, 234, 0.4),
                0 0 0 3px rgba(102, 126, 234, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
        }

        .card:hover::after {
            left: 100%;
        }

        .card:active {
            transform: translateY(-12px) scale(0.98);
        }

        .card.selected {
            background: linear-gradient(145deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-15px) scale(1.08);
            box-shadow:
                0 20px 50px rgba(102, 126, 234, 0.6),
                0 0 0 4px rgba(102, 126, 234, 0.3),
                inset 0 -5px 20px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            animation: cardPulse 2s ease-in-out infinite;
        }

        .card.selected::before {
            opacity: 1;
        }

        @keyframes cardPulse {
            0%, 100% {
                box-shadow:
                    0 20px 50px rgba(102, 126, 234, 0.6),
                    0 0 0 4px rgba(102, 126, 234, 0.3),
                    inset 0 -5px 20px rgba(0, 0, 0, 0.2),
                    inset 0 1px 0 rgba(255, 255, 255, 0.3);
            }
            50% {
                box-shadow:
                    0 22px 55px rgba(102, 126, 234, 0.7),
                    0 0 0 5px rgba(102, 126, 234, 0.4),
                    inset 0 -5px 20px rgba(0, 0, 0, 0.2),
                    inset 0 1px 0 rgba(255, 255, 255, 0.4);
            }
        }

        .players-container {
            margin: 30px 0;
        }

        .players-container h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .players-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .player-card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-card.voted {
            background: #e8f5e9;
            border-left-color: #4caf50;
        }

        .player-name {
            font-weight: 600;
            color: #333;
        }

        .player-vote {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            min-width: 40px;
            text-align: center;
        }

        .vote-status {
            color: #999;
            font-size: 14px;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .btn-reveal {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            box-shadow:
                0 6px 20px rgba(76, 175, 80, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .btn-reveal:hover {
            box-shadow:
                0 10px 30px rgba(76, 175, 80, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .btn-reset {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            box-shadow:
                0 6px 20px rgba(255, 152, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .btn-reset:hover {
            box-shadow:
                0 10px 30px rgba(255, 152, 0, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .btn-leave {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            box-shadow:
                0 6px 20px rgba(244, 67, 54, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .btn-leave:hover {
            box-shadow:
                0 10px 30px rgba(244, 67, 54, 0.5),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .statistics {
            margin-top: 30px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 12px;
            display: none;
        }

        .statistics.show {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
            margin-top: 5px;
        }

        .hidden {
            display: none;
        }

        /* Poker Table Styles */
        .poker-table-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 30px auto;
            padding: 20px;
        }

        .poker-table {
            position: relative;
            width: 600px;
            height: 400px;
            margin: 0 auto;
            background:
                linear-gradient(135deg, rgba(45, 80, 22, 0.95) 0%, rgba(26, 61, 13, 0.95) 100%),
                radial-gradient(ellipse at center, rgba(255, 255, 255, 0.05) 0%, transparent 70%);
            border-radius: 50%;
            border: 20px solid transparent;
            background-clip: padding-box;
            position: relative;
            box-shadow:
                0 0 0 3px rgba(139, 69, 19, 0.8),
                0 0 0 8px rgba(101, 67, 33, 0.6),
                0 0 0 12px rgba(139, 69, 19, 0.4),
                0 20px 60px rgba(0, 0, 0, 0.6),
                inset 0 0 50px rgba(0, 0, 0, 0.4),
                inset 0 5px 20px rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .poker-table:hover {
            box-shadow:
                0 0 0 3px rgba(139, 69, 19, 0.9),
                0 0 0 8px rgba(101, 67, 33, 0.7),
                0 0 0 12px rgba(139, 69, 19, 0.5),
                0 25px 70px rgba(0, 0, 0, 0.7),
                inset 0 0 50px rgba(0, 0, 0, 0.4),
                inset 0 5px 20px rgba(255, 255, 255, 0.05);
        }

        .poker-table::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 60%;
            border: 3px dashed rgba(255, 255, 255, 0.15);
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.05);
            animation: pulse 3s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 0.5;
                transform: translate(-50%, -50%) scale(1);
            }
            50% {
                opacity: 0.8;
                transform: translate(-50%, -50%) scale(1.02);
            }
        }

        .table-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: rgba(255, 255, 255, 0.4);
            font-size: 16px;
            font-style: italic;
            font-weight: 600;
            text-shadow:
                0 2px 10px rgba(0, 0, 0, 0.5),
                0 0 20px rgba(255, 255, 255, 0.1);
            letter-spacing: 2px;
        }

        .player-seat {
            position: absolute;
            width: 80px;
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .player-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background:
                linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 4px solid white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            font-weight: bold;
            box-shadow:
                0 8px 20px rgba(0, 0, 0, 0.3),
                0 0 0 2px rgba(102, 126, 234, 0.3),
                inset 0 -2px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .player-avatar::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(255, 255, 255, 0.3) 50%,
                transparent 70%
            );
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% {
                transform: translateX(-100%) translateY(-100%) rotate(45deg);
            }
            100% {
                transform: translateX(100%) translateY(100%) rotate(45deg);
            }
        }

        .player-avatar:hover {
            transform: scale(1.15) translateY(-5px);
            box-shadow:
                0 12px 30px rgba(0, 0, 0, 0.4),
                0 0 0 3px rgba(102, 126, 234, 0.5),
                inset 0 -2px 8px rgba(0, 0, 0, 0.2),
                0 0 30px rgba(102, 126, 234, 0.3);
        }

        .player-avatar.current-user {
            border-color: #ffd700;
            box-shadow:
                0 8px 25px rgba(255, 215, 0, 0.5),
                0 0 30px rgba(255, 215, 0, 0.4),
                0 0 0 3px rgba(255, 215, 0, 0.3),
                inset 0 -2px 8px rgba(0, 0, 0, 0.2);
            animation: currentUserGlow 2s ease-in-out infinite;
        }

        @keyframes currentUserGlow {
            0%, 100% {
                box-shadow:
                    0 8px 25px rgba(255, 215, 0, 0.5),
                    0 0 30px rgba(255, 215, 0, 0.4),
                    0 0 0 3px rgba(255, 215, 0, 0.3),
                    inset 0 -2px 8px rgba(0, 0, 0, 0.2);
            }
            50% {
                box-shadow:
                    0 8px 30px rgba(255, 215, 0, 0.7),
                    0 0 40px rgba(255, 215, 0, 0.6),
                    0 0 0 4px rgba(255, 215, 0, 0.5),
                    inset 0 -2px 8px rgba(0, 0, 0, 0.2);
            }
        }

        .player-seat-name {
            margin-top: 5px;
            font-size: 11px;
            font-weight: 600;
            color: #333;
            background: rgba(255, 255, 255, 0.9);
            padding: 2px 8px;
            border-radius: 10px;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .player-vote-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            color: white;
            font-weight: bold;
            border: 3px solid white;
            box-shadow:
                0 4px 12px rgba(76, 175, 80, 0.5),
                0 0 0 2px rgba(76, 175, 80, 0.2),
                inset 0 -2px 4px rgba(0, 0, 0, 0.2);
            z-index: 10;
            animation: badgePop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes badgePop {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .player-vote-badge.waiting {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            box-shadow:
                0 4px 12px rgba(255, 152, 0, 0.5),
                0 0 0 2px rgba(255, 152, 0, 0.2),
                inset 0 -2px 4px rgba(0, 0, 0, 0.2);
            animation: waitingPulse 1.5s ease-in-out infinite;
        }

        @keyframes waitingPulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        /* Emoji System */
        .emoji-selector {
            position: fixed;
            background: white;
            border-radius: 16px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1000;
            max-width: 350px;
            max-height: 450px;
            transform-origin: left center;
            animation: emojiSelectorPop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes emojiSelectorPop {
            0% {
                opacity: 0;
                transform: scale(0.8) translateY(-10px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .emoji-selector.show {
            display: flex;
            flex-direction: column;
        }

        .emoji-selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .emoji-selector-title {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .emoji-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
        }

        .emoji-close:hover {
            color: #333;
            background: #f0f0f0;
            border-radius: 50%;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            max-height: 350px;
            overflow-y: auto;
            padding: 5px;
        }

        .emoji-grid::-webkit-scrollbar {
            width: 8px;
        }

        .emoji-grid::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .emoji-grid::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .emoji-grid::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .emoji-recent {
            display: flex;
            gap: 8px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 12px;
            margin-bottom: 10px;
            border: 2px dashed #e0e0e0;
        }

        .emoji-recent-title {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 5px;
            letter-spacing: 0.5px;
        }

        .emoji-item {
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            background: #f5f5f5;
        }

        .emoji-item:hover {
            background: #e0e0e0;
            transform: scale(1.15);
            z-index: 1;
        }

        .emoji-item.recent {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border: 2px solid #667eea30;
        }

        .emoji-item.recent:hover {
            background: linear-gradient(135deg, #667eea30 0%, #764ba230 100%);
            border-color: #667eea50;
        }

        .emoji-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: 3px solid white;
            font-size: 18px;
            cursor: pointer;
            box-shadow:
                0 6px 16px rgba(102, 126, 234, 0.5),
                0 0 0 2px rgba(102, 126, 234, 0.2),
                inset 0 -2px 4px rgba(0, 0, 0, 0.2);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 10;
            opacity: 0;
            pointer-events: none;
        }

        .player-avatar:hover .emoji-btn {
            opacity: 1;
            pointer-events: all;
            transform: translate(-50%, -50%) scale(1);
        }

        .emoji-btn:hover {
            transform: translate(-50%, -50%) scale(1.25);
            box-shadow:
                0 8px 20px rgba(102, 126, 234, 0.7),
                0 0 0 3px rgba(102, 126, 234, 0.3),
                inset 0 -2px 4px rgba(0, 0, 0, 0.2);
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        .emoji-btn:active {
            transform: translate(-50%, -50%) scale(1.1);
        }

        /* Flying Emoji Animation */
        .flying-emoji {
            position: fixed;
            font-size: 48px;
            pointer-events: none;
            z-index: 2000;
            transition: all 1.2s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            filter: drop-shadow(2px 2px 4px rgba(0, 0, 0, 0.3));
        }

        .flying-emoji.paper-throw {
            animation: paperRotate 1.2s ease-out forwards;
        }

        @keyframes paperRotate {
            0% {
                transform: scale(0.8) rotate(0deg);
            }
            25% {
                transform: scale(1.1) rotate(90deg);
            }
            50% {
                transform: scale(1.2) rotate(180deg);
            }
            75% {
                transform: scale(1.1) rotate(270deg);
            }
            100% {
                opacity: 0.3;
                transform: scale(0.9) rotate(360deg);
            }
        }

        .emoji-notification {
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 24px;
            white-space: nowrap;
            animation: emojiPop 2s ease-out forwards;
            z-index: 100;
        }

        @keyframes emojiPop {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(10px) scale(0.5);
            }
            20% {
                opacity: 1;
                transform: translateX(-50%) translateY(-10px) scale(1.2);
            }
            80% {
                opacity: 1;
                transform: translateX(-50%) translateY(-10px) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px) scale(0.8);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 2em;
            }

            .cards-container {
                grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
                gap: 10px;
            }

            .card {
                font-size: 20px;
            }

            .poker-table {
                width: 100%;
                max-width: 400px;
                height: 300px;
            }

            .player-avatar {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }

            .player-seat {
                width: 70px;
                height: 70px;
            }

            .emoji-btn {
                width: 50px;
                height: 50px;
                font-size: 24px;
            }

            .emoji-selector {
                max-width: 250px;
                bottom: 80px;
            }

            .emoji-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üÉè Planning Poker</h1>

        <!-- Setup Screen -->
        <div class="setup-screen" id="setupScreen">
            <div class="input-group">
                <label for="userName">Tu nombre:</label>
                <input type="text" id="userName" placeholder="Ingresa tu nombre" />
            </div>
            <div class="input-group">
                <label for="roomId">ID de la sala:</label>
                <input type="text" id="roomId" placeholder="Ingresa o crea una sala" />
            </div>
            <button onclick="joinRoom()">Unirse a la Sala</button>
        </div>

        <!-- Game Screen -->
        <div class="game-screen" id="gameScreen">
            <div class="game-info">
                <h2>Sala: <span id="currentRoom"></span></h2>
                <p>Usuario: <strong id="currentUser"></strong></p>
            </div>

            <!-- Poker Table -->
            <div class="poker-table-container">
                <div class="poker-table" id="pokerTable">
                    <div class="table-center">Planning Poker</div>
                </div>
            </div>

            <div class="cards-container" id="cardsContainer"></div>

            <div class="players-container">
                <h3>Jugadores (<span id="playerCount">0</span>)</h3>
                <div class="players-list" id="playersList"></div>
            </div>

            <div class="statistics" id="statistics">
                <h3>Estad√≠sticas</h3>
                <div class="stats-grid" id="statsGrid"></div>
            </div>

            <div class="controls">
                <button class="btn-reveal" onclick="revealVotes()">Revelar Votos</button>
                <button class="btn-reset" onclick="resetVotes()">Nueva Votaci√≥n</button>
                <button class="btn-leave" onclick="leaveRoom()">Salir de la Sala</button>
            </div>

            <!-- Emoji System -->
            <div class="emoji-selector" id="emojiSelector">
                <div class="emoji-selector-header">
                    <span class="emoji-selector-title">Selecciona un jugador</span>
                    <button class="emoji-close" onclick="closeEmojiSelector()">√ó</button>
                </div>
                <div id="emojiTargetPlayers"></div>
            </div>
        </div>
    </div>

    <script type="module">
        // Import Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD7xBEPmQrTwCODScHJaTmvwAVI3Tdt16M",
            authDomain: "planning-poker-b13a2.firebaseapp.com",
            databaseURL: "https://planning-poker-b13a2-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "planning-poker-b13a2",
            storageBucket: "planning-poker-b13a2.firebasestorage.app",
            messagingSenderId: "479606415356",
            appId: "1:479606415356:web:c326a70ea02e45ac5b1c79"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Global variables
        let currentRoomId = null;
        let currentUserName = null;
        let currentUserId = null;
        let isRevealed = false;
        let selectedEmojiForSend = null;
        let recentEmojis = ['üëç', '‚ù§Ô∏è', 'üòÇ', 'üéâ', 'üî•']; // Default recent emojis
        let currentTargetPlayer = null;

        const estimationValues = [1, 2, 3, 4, 5, 10, 15, 20, 30, 40, 50, 100];
        // Expanded emoji list similar to WhatsApp
        const emojis = [
            // Smileys & Emotion
            'üòÄ', 'üòÉ', 'üòÑ', 'üòÅ', 'üòÜ', 'üòÖ', 'ü§£', 'üòÇ', 'üôÇ', 'üôÉ', 'üòâ', 'üòä', 'üòá',
            'ü•∞', 'üòç', 'ü§©', 'üòò', 'üòó', 'üòö', 'üòô', 'üòã', 'üòõ', 'üòú', 'ü§™', 'üòù', 'ü§ë',
            'ü§ó', 'ü§≠', 'ü§´', 'ü§î', 'ü§ê', 'ü§®', 'üòê', 'üòë', 'üò∂', 'üòè', 'üòí', 'üôÑ', 'üò¨',
            'ü§•', 'üòå', 'üòî', 'üò™', 'ü§§', 'üò¥', 'üò∑', 'ü§í', 'ü§ï', 'ü§¢', 'ü§Æ', 'ü§ß', 'ü•µ',
            'ü•∂', 'ü•¥', 'üòµ', 'ü§Ø', 'ü§†', 'ü•≥', 'üòé', 'ü§ì', 'üßê', 'üòï', 'üòü', 'üôÅ', '‚òπÔ∏è',
            'üòÆ', 'üòØ', 'üò≤', 'üò≥', 'ü•∫', 'üò¶', 'üòß', 'üò®', 'üò∞', 'üò•', 'üò¢', 'üò≠', 'üò±',
            'üòñ', 'üò£', 'üòû', 'üòì', 'üò©', 'üò´', 'ü•±', 'üò§', 'üò°', 'üò†', 'ü§¨', 'üòà', 'üëø',
            // Gestures & Body Parts
            'üëã', 'ü§ö', 'üñêÔ∏è', '‚úã', 'üññ', 'üëå', 'ü§è', '‚úåÔ∏è', 'ü§û', 'ü§ü', 'ü§ò', 'ü§ô', 'üëà',
            'üëâ', 'üëÜ', 'üñï', 'üëá', '‚òùÔ∏è', 'üëç', 'üëé', '‚úä', 'üëä', 'ü§õ', 'ü§ú', 'üëè', 'üôå',
            'üëê', 'ü§≤', 'ü§ù', 'üôè', '‚úçÔ∏è', 'üí™', 'ü¶æ', 'ü¶ø', 'ü¶µ', 'ü¶∂', 'üëÇ', 'ü¶ª', 'üëÉ',
            'üß†', 'ü¶∑', 'ü¶¥', 'üëÄ', 'üëÅÔ∏è', 'üëÖ', 'üëÑ',
            // Animals & Nature
            'üê∂', 'üê±', 'üê≠', 'üêπ', 'üê∞', 'ü¶ä', 'üêª', 'üêº', 'üê®', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑',
            'üê∏', 'üêµ', 'üôà', 'üôâ', 'üôä', 'üêî', 'üêß', 'üê¶', 'üê§', 'üê£', 'üê•', 'ü¶Ü', 'ü¶Ö',
            'ü¶â', 'ü¶á', 'üê∫', 'üêó', 'üê¥', 'ü¶Ñ', 'üêù', 'üêõ', 'ü¶ã', 'üêå', 'üêû', 'üêú', 'ü¶ü',
            'ü¶ó', 'üï∑Ô∏è', 'ü¶Ç', 'üê¢', 'üêç', 'ü¶é', 'ü¶ñ', 'ü¶ï', 'üêô', 'ü¶ë', 'ü¶ê', 'ü¶û', 'ü¶Ä',
            'üê°', 'üê†', 'üêü', 'üê¨', 'üê≥', 'üêã', 'ü¶à', 'üêä', 'üêÖ', 'üêÜ', 'ü¶ì', 'ü¶ç', 'ü¶ß',
            'üêò', 'ü¶õ', 'ü¶è', 'üê™', 'üê´', 'ü¶í', 'ü¶ò', 'üêÉ', 'üêÇ', 'üêÑ', 'üêé', 'üêñ', 'üêè',
            'üêë', 'ü¶ô', 'üêê', 'ü¶å', 'üêï', 'üê©', 'ü¶Æ', 'üêà', 'üêì', 'ü¶É', 'ü¶ö', 'ü¶ú', 'ü¶¢',
            'ü¶©', 'üïäÔ∏è', 'üêá', 'ü¶ù', 'ü¶®', 'ü¶°', 'ü¶¶', 'ü¶•', 'üêÅ', 'üêÄ', 'üêøÔ∏è', 'ü¶î',
            // Food & Drink
            'üçé', 'üçä', 'üçã', 'üçå', 'üçâ', 'üçá', 'üçì', 'üçà', 'üçí', 'üçë', 'ü•≠', 'üçç', 'ü••',
            'ü•ù', 'üçÖ', 'üçÜ', 'ü•ë', 'ü•¶', 'ü•¨', 'ü•í', 'üå∂Ô∏è', 'üåΩ', 'ü•ï', 'üßÑ', 'üßÖ', 'ü•î',
            'üç†', 'ü•ê', 'ü•Ø', 'üçû', 'ü•ñ', 'ü•®', 'üßÄ', 'ü•ö', 'üç≥', 'üßà', 'ü•û', 'üßá', 'ü•ì',
            'ü•©', 'üçó', 'üçñ', 'ü¶¥', 'üå≠', 'üçî', 'üçü', 'üçï', 'ü•™', 'ü•ô', 'üßÜ', 'üåÆ', 'üåØ',
            'ü•ó', 'ü•ò', 'ü•´', 'üçù', 'üçú', 'üç≤', 'üçõ', 'üç£', 'üç±', 'ü•ü', 'ü¶™', 'üç§', 'üçô',
            'üçö', 'üçò', 'üç•', 'ü•†', 'ü•Æ', 'üç¢', 'üç°', 'üçß', 'üç®', 'üç¶', 'ü•ß', 'üßÅ', 'üç∞',
            'üéÇ', 'üçÆ', 'üç≠', 'üç¨', 'üç´', 'üçø', 'üç©', 'üç™', 'üå∞', 'ü•ú', 'üçØ', 'ü•õ', 'üçº',
            '‚òï', 'üçµ', 'üßÉ', 'ü•§', 'üç∂', 'üç∫', 'üçª', 'ü•Ç', 'üç∑', 'ü•É', 'üç∏', 'üçπ', 'üßâ',
            'üçæ', 'üßä',
            // Activities & Sports
            '‚öΩ', 'üèÄ', 'üèà', '‚öæ', 'ü•é', 'üéæ', 'üèê', 'üèâ', 'ü•è', 'üé±', 'ü™Ä', 'üèì', 'üè∏',
            'üèí', 'üèë', 'ü•ç', 'üèè', 'ü•Ö', '‚õ≥', 'ü™Å', 'üèπ', 'üé£', 'ü§ø', 'ü•ä', 'ü•ã', 'üéΩ',
            'üõπ', 'üõ∑', '‚õ∏Ô∏è', 'ü•å', 'üéø', '‚õ∑Ô∏è', 'üèÇ', 'ü™Ç', 'üèãÔ∏è', 'ü§º', 'ü§∏', 'ü§∫', '‚õπÔ∏è',
            'ü§æ', 'üèåÔ∏è', 'üèá', 'üßò', 'üèä', 'ü§Ω', 'üö£', 'üßó', 'üö¥', 'üöµ', 'üé™', 'üé≠', 'üé®',
            'üé¨', 'üé§', 'üéß', 'üéº', 'üéπ', 'ü•Å', 'üé∑', 'üé∫', 'üé∏', 'ü™ï', 'üéª', 'üé≤', '‚ôüÔ∏è',
            'üéØ', 'üé≥', 'üéÆ', 'üé∞', 'üß©',
            // Travel & Places
            'üöó', 'üöï', 'üöô', 'üöå', 'üöé', 'üèéÔ∏è', 'üöì', 'üöë', 'üöí', 'üöê', 'üöö', 'üöõ', 'üöú',
            'ü¶Ø', 'ü¶Ω', 'ü¶º', 'üõ¥', 'üö≤', 'üõµ', 'üèçÔ∏è', 'üõ∫', 'üö®', 'üöî', 'üöç', 'üöò', 'üöñ',
            'üö°', 'üö†', 'üöü', 'üöÉ', 'üöã', 'üöû', 'üöù', 'üöÑ', 'üöÖ', 'üöà', 'üöÇ', 'üöÜ', 'üöá',
            'üöä', 'üöâ', '‚úàÔ∏è', 'üõ´', 'üõ¨', 'üõ©Ô∏è', 'üí∫', 'üõ∞Ô∏è', 'üöÄ', 'üõ∏', 'üöÅ', 'üõ∂', '‚õµ',
            'üö§', 'üõ•Ô∏è', 'üõ≥Ô∏è', '‚õ¥Ô∏è', 'üö¢', '‚öì', '‚õΩ', 'üöß', 'üö¶', 'üö•', 'üöè', 'üó∫Ô∏è', 'üóø',
            'üóΩ', 'üóº', 'üè∞', 'üèØ', 'üèüÔ∏è', 'üé°', 'üé¢', 'üé†', '‚õ≤', '‚õ±Ô∏è', 'üèñÔ∏è', 'üèùÔ∏è', 'üèúÔ∏è',
            'üåã', '‚õ∞Ô∏è', 'üèîÔ∏è', 'üóª', 'üèïÔ∏è', '‚õ∫', 'üè†', 'üè°', 'üèòÔ∏è', 'üèöÔ∏è', 'üèóÔ∏è', 'üè≠', 'üè¢',
            'üè¨', 'üè£', 'üè§', 'üè•', 'üè¶', 'üè®', 'üè™', 'üè´', 'üè©', 'üíí', 'üèõÔ∏è', '‚õ™', 'üïå',
            'üïç', 'üõï', 'üïã', '‚õ©Ô∏è', 'üõ§Ô∏è', 'üõ£Ô∏è', 'üóæ', 'üéë', 'üèûÔ∏è', 'üåÖ', 'üåÑ', 'üå†', 'üéá',
            'üéÜ', 'üåá', 'üåÜ', 'üèôÔ∏è', 'üåÉ', 'üåå', 'üåâ', 'üåÅ',
            // Objects
            '‚åö', 'üì±', 'üì≤', 'üíª', '‚å®Ô∏è', 'üñ•Ô∏è', 'üñ®Ô∏è', 'üñ±Ô∏è', 'üñ≤Ô∏è', 'üïπÔ∏è', 'üóúÔ∏è', 'üíæ', 'üíø',
            'üìÄ', 'üìº', 'üì∑', 'üì∏', 'üìπ', 'üé•', 'üìΩÔ∏è', 'üéûÔ∏è', 'üìû', '‚òéÔ∏è', 'üìü', 'üì†', 'üì∫',
            'üìª', 'üéôÔ∏è', 'üéöÔ∏è', 'üéõÔ∏è', 'üß≠', '‚è±Ô∏è', '‚è≤Ô∏è', '‚è∞', 'üï∞Ô∏è', '‚åõ', '‚è≥', 'üì°', 'üîã',
            'üîå', 'üí°', 'üî¶', 'üïØÔ∏è', 'ü™î', 'üßØ', 'üõ¢Ô∏è', 'üí∏', 'üíµ', 'üí¥', 'üí∂', 'üí∑', 'üí∞',
            'üí≥', 'üíé', '‚öñÔ∏è', 'üß∞', 'üîß', 'üî®', '‚öíÔ∏è', 'üõ†Ô∏è', '‚õèÔ∏è', 'üî©', '‚öôÔ∏è', 'üß±', '‚õìÔ∏è',
            'üß≤', 'üî´', 'üí£', 'üß®', 'ü™ì', 'üî™', 'üó°Ô∏è', '‚öîÔ∏è', 'üõ°Ô∏è', 'üö¨', '‚ö∞Ô∏è', '‚ö±Ô∏è', 'üè∫',
            'üîÆ', 'üìø', 'üßø', 'üíà', '‚öóÔ∏è', 'üî≠', 'üî¨', 'üï≥Ô∏è', 'ü©π', 'ü©∫', 'üíä', 'üíâ', 'ü©∏',
            'üß¨', 'ü¶†', 'üß´', 'üß™', 'üå°Ô∏è', 'üßπ', 'üß∫', 'üßª', 'üöΩ', 'üö∞', 'üöø', 'üõÅ', 'üõÄ',
            'üßº', 'ü™í', 'üßΩ', 'üß¥', 'üõéÔ∏è', 'üîë', 'üóùÔ∏è', 'üö™', 'ü™ë', 'üõãÔ∏è', 'üõèÔ∏è', 'üõå', 'üß∏',
            'üñºÔ∏è', 'üõçÔ∏è', 'üõí', 'üéÅ', 'üéà', 'üéè', 'üéÄ', 'üéä', 'üéâ', 'üéé', 'üèÆ', 'üéê', 'üßß',
            // Symbols
            '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üñ§', 'ü§ç', 'ü§é', 'üíî', '‚ù£Ô∏è', 'üíï', 'üíû',
            'üíì', 'üíó', 'üíñ', 'üíò', 'üíù', 'üíü', '‚òÆÔ∏è', '‚úùÔ∏è', '‚ò™Ô∏è', 'üïâÔ∏è', '‚ò∏Ô∏è', '‚ú°Ô∏è', 'üîØ',
            'üïé', '‚òØÔ∏è', '‚ò¶Ô∏è', 'üõê', '‚õé', '‚ôà', '‚ôâ', '‚ôä', '‚ôã', '‚ôå', '‚ôç', '‚ôé', '‚ôè', '‚ôê',
            '‚ôë', '‚ôí', '‚ôì', 'üÜî', '‚öõÔ∏è', 'üâë', '‚ò¢Ô∏è', '‚ò£Ô∏è', 'üì¥', 'üì≥', 'üà∂', 'üàö', 'üà∏',
            'üà∫', 'üà∑Ô∏è', '‚ú¥Ô∏è', 'üÜö', 'üíÆ', 'üâê', '„äôÔ∏è', '„äóÔ∏è', 'üà¥', 'üàµ', 'üàπ', 'üà≤', 'üÖ∞Ô∏è',
            'üÖ±Ô∏è', 'üÜé', 'üÜë', 'üÖæÔ∏è', 'üÜò', '‚ùå', '‚≠ï', 'üõë', '‚õî', 'üìõ', 'üö´', 'üíØ', 'üí¢',
            '‚ô®Ô∏è', 'üö∑', 'üöØ', 'üö≥', 'üö±', 'üîû', 'üìµ', 'üö≠', '‚ùó', '‚ùï', '‚ùì', '‚ùî', '‚ÄºÔ∏è',
            '‚ÅâÔ∏è', 'üîÖ', 'üîÜ', '„ÄΩÔ∏è', '‚ö†Ô∏è', 'üö∏', 'üî±', '‚öúÔ∏è', 'üî∞', '‚ôªÔ∏è', '‚úÖ', 'üàØ', 'üíπ',
            '‚ùáÔ∏è', '‚ú≥Ô∏è', '‚ùé', 'üåê', 'üí†', 'üî†', 'üî°', 'üî¢', 'üî£', 'üî§', 'üÖøÔ∏è', 'üÜó', 'üÜô',
            'üÜí', 'üÜï', 'üÜì', '0Ô∏è‚É£', '1Ô∏è‚É£', '2Ô∏è‚É£', '3Ô∏è‚É£', '4Ô∏è‚É£', '5Ô∏è‚É£', '6Ô∏è‚É£', '7Ô∏è‚É£', '8Ô∏è‚É£', '9Ô∏è‚É£',
            'üîü', 'üî¢', '‚èèÔ∏è', '‚ñ∂Ô∏è', '‚è∏Ô∏è', '‚èØÔ∏è', '‚èπÔ∏è', '‚è∫Ô∏è', '‚è≠Ô∏è', '‚èÆÔ∏è', '‚è©', '‚è™', '‚è´',
            '‚è¨', '‚óÄÔ∏è', 'üîº', 'üîΩ', '‚û°Ô∏è', '‚¨ÖÔ∏è', '‚¨ÜÔ∏è', '‚¨áÔ∏è', '‚ÜóÔ∏è', '‚ÜòÔ∏è', '‚ÜôÔ∏è', '‚ÜñÔ∏è', '‚ÜïÔ∏è',
            '‚ÜîÔ∏è', '‚Ü™Ô∏è', '‚Ü©Ô∏è', '‚§¥Ô∏è', '‚§µÔ∏è', 'üîÄ', 'üîÅ', 'üîÇ', 'üîÑ', 'üîÉ', 'üéµ', 'üé∂', '‚úñÔ∏è',
            'üí≤', 'üí±', '‚Ñ¢Ô∏è', '¬©Ô∏è', '¬ÆÔ∏è', '„Ä∞Ô∏è', '‚û∞', '‚ûø', 'üîö', 'üîô', 'üîõ', 'üîù', 'üîú',
            '‚úîÔ∏è', '‚òëÔ∏è', 'üîò', 'üî¥', 'üü†', 'üü°', 'üü¢', 'üîµ', 'üü£', '‚ö´', '‚ö™', 'üü§', 'üî∫',
            'üîª', 'üî∏', 'üîπ', 'üî∂', 'üî∑', 'üî≥', 'üî≤', '‚ñ™Ô∏è', '‚ñ´Ô∏è', '‚óæ', '‚óΩ', '‚óºÔ∏è', '‚óªÔ∏è',
            'üü•', 'üüß', 'üü®', 'üü©', 'üü¶', 'üü™', '‚¨õ', '‚¨ú', 'üü´', 'üîà', 'üîá', 'üîâ', 'üîä',
            'üîî', 'üîï', 'üì£', 'üì¢', 'üí¨', 'üí≠', 'üóØÔ∏è', '‚ô†Ô∏è', '‚ô£Ô∏è', '‚ô•Ô∏è', '‚ô¶Ô∏è', 'üÉè', 'üé¥',
            'üÄÑ', 'üïê', 'üïë', 'üïí', 'üïì', 'üïî', 'üïï', 'üïñ', 'üïó', 'üïò', 'üïô', 'üïö', 'üïõ',
            'üïú', 'üïù', 'üïû', 'üïü', 'üï†', 'üï°', 'üï¢', 'üï£', 'üï§', 'üï•', 'üï¶', 'üïß'
        ];

        // Make functions globally accessible
        window.joinRoom = joinRoom;
        window.selectCard = selectCard;
        window.revealVotes = revealVotes;
        window.resetVotes = resetVotes;
        window.leaveRoom = leaveRoom;
        window.toggleEmojiSelector = toggleEmojiSelector;
        window.closeEmojiSelector = closeEmojiSelector;
        window.sendEmojiToPlayer = sendEmojiToPlayer;

        // Initialize cards
        function initializeCards() {
            const cardsContainer = document.getElementById('cardsContainer');
            cardsContainer.innerHTML = '';

            estimationValues.forEach(value => {
                const card = document.createElement('div');
                card.className = 'card';
                card.textContent = value;
                card.onclick = () => selectCard(value);
                card.dataset.value = value;
                cardsContainer.appendChild(card);
            });
        }

        // Calculate player position around the poker table
        function calculatePlayerPosition(index, total) {
            const table = document.getElementById('pokerTable');
            const tableWidth = table.offsetWidth;
            const tableHeight = table.offsetHeight;

            // Calculate angle for this player (distribute evenly around circle)
            const angle = (index / total) * 2 * Math.PI - Math.PI / 2; // Start from top

            // Calculate position on ellipse
            const radiusX = (tableWidth / 2) - 60; // 60px padding
            const radiusY = (tableHeight / 2) - 60;

            const x = tableWidth / 2 + radiusX * Math.cos(angle) - 40; // 40 = half of player seat width
            const y = tableHeight / 2 + radiusY * Math.sin(angle) - 40; // 40 = half of player seat height

            return { x, y };
        }

        // Render poker table with players
        function renderPokerTable(players) {
            const pokerTable = document.getElementById('pokerTable');

            // Remove existing player seats (keep table center)
            const existingSeats = pokerTable.querySelectorAll('.player-seat');
            existingSeats.forEach(seat => seat.remove());

            const playerEntries = Object.entries(players);
            const totalPlayers = playerEntries.length;

            playerEntries.forEach(([playerId, player], index) => {
                const position = calculatePlayerPosition(index, totalPlayers);

                const playerSeat = document.createElement('div');
                playerSeat.className = 'player-seat';
                playerSeat.style.left = `${position.x}px`;
                playerSeat.style.top = `${position.y}px`;
                playerSeat.dataset.playerId = playerId;

                const avatar = document.createElement('div');
                avatar.className = 'player-avatar';
                if (playerId === currentUserId) {
                    avatar.classList.add('current-user');
                }
                avatar.textContent = player.name.charAt(0).toUpperCase();

                // Add emoji button to other players (not current user)
                if (playerId !== currentUserId) {
                    const emojiBtn = document.createElement('button');
                    emojiBtn.className = 'emoji-btn';
                    emojiBtn.textContent = 'üòä';
                    emojiBtn.onclick = (e) => {
                        e.stopPropagation();
                        showEmojiPickerForPlayer(playerId, player.name);
                    };
                    avatar.appendChild(emojiBtn);
                }

                // Add vote badge
                if (player.voted) {
                    const badge = document.createElement('div');
                    badge.className = 'player-vote-badge';
                    if (isRevealed && player.vote !== null) {
                        badge.textContent = player.vote;
                    } else {
                        badge.textContent = '‚úì';
                        badge.classList.add('waiting');
                    }
                    avatar.appendChild(badge);
                }

                const nameLabel = document.createElement('div');
                nameLabel.className = 'player-seat-name';
                nameLabel.textContent = player.name;

                playerSeat.appendChild(avatar);
                playerSeat.appendChild(nameLabel);
                pokerTable.appendChild(playerSeat);
            });
        }

        // Emoji selector functions
        function toggleEmojiSelector() {
            const selector = document.getElementById('emojiSelector');
            if (selector.classList.contains('show')) {
                closeEmojiSelector();
            } else {
                // Show player selection first
                showEmojiTargetSelection();
                selector.classList.add('show');
            }
        }

        function closeEmojiSelector() {
            document.getElementById('emojiSelector').classList.remove('show');
            selectedEmojiForSend = null;
            currentTargetPlayer = null;
        }

        function showEmojiTargetSelection() {
            const container = document.getElementById('emojiTargetPlayers');
            container.innerHTML = '<p style="font-size: 12px; color: #666; margin-bottom: 10px;">Haz click en un jugador de la mesa</p>';
        }

        function showEmojiPickerForPlayer(targetPlayerId, targetPlayerName) {
            if (targetPlayerId === currentUserId) {
                return; // Can't send emoji to yourself
            }

            currentTargetPlayer = { id: targetPlayerId, name: targetPlayerName };

            const selector = document.getElementById('emojiSelector');
            const container = document.getElementById('emojiTargetPlayers');

            // Update title
            document.querySelector('.emoji-selector-title').textContent = `Enviar a ${targetPlayerName}`;

            // Position selector near the player avatar
            const playerSeat = document.querySelector(`[data-player-id="${targetPlayerId}"]`);
            if (playerSeat) {
                const rect = playerSeat.getBoundingClientRect();
                const selectorWidth = 350;
                const selectorHeight = 450;

                // Position to the right of the avatar, or left if not enough space
                let left = rect.right + 15;
                let top = rect.top - 100;

                // Adjust if goes off screen
                if (left + selectorWidth > window.innerWidth) {
                    left = rect.left - selectorWidth - 15;
                }
                if (top < 10) {
                    top = 10;
                }
                if (top + selectorHeight > window.innerHeight) {
                    top = window.innerHeight - selectorHeight - 10;
                }

                selector.style.left = `${left}px`;
                selector.style.top = `${top}px`;
            }

            // Show emoji picker
            container.innerHTML = '';

            // Add recent emojis section
            if (recentEmojis.length > 0) {
                const recentTitle = document.createElement('div');
                recentTitle.className = 'emoji-recent-title';
                recentTitle.textContent = 'Recientes';
                container.appendChild(recentTitle);

                const recentContainer = document.createElement('div');
                recentContainer.className = 'emoji-recent';

                recentEmojis.slice(0, 5).forEach(emoji => {
                    const emojiItem = document.createElement('div');
                    emojiItem.className = 'emoji-item recent';
                    emojiItem.textContent = emoji;
                    emojiItem.onclick = () => sendEmojiToPlayer(emoji, targetPlayerId);
                    recentContainer.appendChild(emojiItem);
                });

                container.appendChild(recentContainer);
            }

            // Add all emojis grid
            const allTitle = document.createElement('div');
            allTitle.className = 'emoji-recent-title';
            allTitle.textContent = 'Todos los emojis';
            allTitle.style.marginTop = '10px';
            container.appendChild(allTitle);

            const emojiGrid = document.createElement('div');
            emojiGrid.className = 'emoji-grid';

            emojis.forEach(emoji => {
                const emojiItem = document.createElement('div');
                emojiItem.className = 'emoji-item';
                emojiItem.textContent = emoji;
                emojiItem.onclick = () => sendEmojiToPlayer(emoji, targetPlayerId);
                emojiGrid.appendChild(emojiItem);
            });

            container.appendChild(emojiGrid);
            selector.classList.add('show');
        }

        function sendEmojiToPlayer(emoji, targetPlayerId) {
            if (!currentRoomId || !currentUserId) return;

            // Update recent emojis
            updateRecentEmojis(emoji);

            // Send emoji via Firebase
            const emojiRef = ref(database, `rooms/${currentRoomId}/emojis/${Date.now()}`);
            set(emojiRef, {
                emoji: emoji,
                from: currentUserId,
                fromName: currentUserName,
                to: targetPlayerId,
                timestamp: Date.now()
            });

            // DON'T close the selector - allow spam mode
            // Refresh the emoji picker to show updated recents
            if (currentTargetPlayer) {
                showEmojiPickerForPlayer(currentTargetPlayer.id, currentTargetPlayer.name);
            }

            // Show flying animation locally
            showFlyingEmojiAnimation(emoji, currentUserId, targetPlayerId);
        }

        function updateRecentEmojis(emoji) {
            // Remove emoji if it already exists
            recentEmojis = recentEmojis.filter(e => e !== emoji);

            // Add to the beginning
            recentEmojis.unshift(emoji);

            // Keep only top 5
            if (recentEmojis.length > 5) {
                recentEmojis = recentEmojis.slice(0, 5);
            }

            // Save to localStorage
            try {
                localStorage.setItem('planning-poker-recent-emojis', JSON.stringify(recentEmojis));
            } catch (e) {
                // Ignore localStorage errors
            }
        }

        function loadRecentEmojis() {
            try {
                const saved = localStorage.getItem('planning-poker-recent-emojis');
                if (saved) {
                    recentEmojis = JSON.parse(saved);
                }
            } catch (e) {
                // Ignore localStorage errors
            }
        }

        function showFlyingEmojiAnimation(emoji, fromPlayerId, toPlayerId) {
            const fromSeat = document.querySelector(`[data-player-id="${fromPlayerId}"]`);
            const toSeat = document.querySelector(`[data-player-id="${toPlayerId}"]`);

            if (!fromSeat || !toSeat) return;

            const fromRect = fromSeat.getBoundingClientRect();
            const toRect = toSeat.getBoundingClientRect();

            const flyingEmoji = document.createElement('div');
            flyingEmoji.className = 'flying-emoji';
            flyingEmoji.textContent = emoji;

            const startX = fromRect.left + fromRect.width / 2;
            const startY = fromRect.top + fromRect.height / 2;
            const endX = toRect.left + toRect.width / 2;
            const endY = toRect.top + toRect.height / 2;

            flyingEmoji.style.left = `${startX}px`;
            flyingEmoji.style.top = `${startY}px`;

            document.body.appendChild(flyingEmoji);

            // Calculate parabolic arc (paper throw effect)
            const distance = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
            const arcHeight = Math.min(distance * 0.3, 150); // Parabolic arc height

            // Add paper throw animation
            flyingEmoji.classList.add('paper-throw');

            // Animate to target with parabolic arc using keyframes
            const keyframes = [];
            const steps = 30;
            for (let i = 0; i <= steps; i++) {
                const progress = i / steps;
                // Cubic bezier for smooth motion
                const easeProgress = progress < 0.5
                    ? 4 * progress * progress * progress
                    : 1 - Math.pow(-2 * progress + 2, 3) / 2;

                const x = startX + (endX - startX) * easeProgress;
                // Parabolic curve: goes up then down
                const parabola = 4 * arcHeight * progress * (1 - progress);
                const y = startY + (endY - startY) * easeProgress - parabola;

                keyframes.push({
                    left: `${x}px`,
                    top: `${y}px`,
                    offset: progress
                });
            }

            flyingEmoji.animate(keyframes, {
                duration: 1200,
                easing: 'ease-out',
                fill: 'forwards'
            });

            // Remove after animation
            setTimeout(() => {
                flyingEmoji.remove();
            }, 1300);
        }

        function showEmojiNotification(emoji, fromName, playerSeat) {
            const notification = document.createElement('div');
            notification.className = 'emoji-notification';
            notification.textContent = `${emoji} de ${fromName}`;

            playerSeat.style.position = 'relative';
            playerSeat.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        function listenForEmojis() {
            if (!currentRoomId) return;

            const emojisRef = ref(database, `rooms/${currentRoomId}/emojis`);
            onValue(emojisRef, (snapshot) => {
                const emojisData = snapshot.val();
                if (!emojisData) return;

                // Get the latest emoji
                const emojiEntries = Object.entries(emojisData);
                const latestEmoji = emojiEntries[emojiEntries.length - 1];

                if (latestEmoji) {
                    const [emojiId, emojiData] = latestEmoji;

                    // Check if this emoji is for current user
                    if (emojiData.to === currentUserId) {
                        const mySeat = document.querySelector(`[data-player-id="${currentUserId}"]`);
                        if (mySeat) {
                            showEmojiNotification(emojiData.emoji, emojiData.fromName, mySeat);
                        }

                        // Show flying animation for receiver
                        showFlyingEmojiAnimation(emojiData.emoji, emojiData.from, emojiData.to);
                    } else if (emojiData.from !== currentUserId && emojiData.to !== currentUserId) {
                        // Show animation for other players watching
                        showFlyingEmojiAnimation(emojiData.emoji, emojiData.from, emojiData.to);
                    }
                }
            });
        }

        // Join room
        function joinRoom() {
            const userName = document.getElementById('userName').value.trim();
            const roomId = document.getElementById('roomId').value.trim();

            if (!userName || !roomId) {
                alert('Por favor ingresa tu nombre y el ID de la sala');
                return;
            }

            currentUserName = userName;
            currentRoomId = roomId;
            currentUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

            // Add user to room
            const userRef = ref(database, `rooms/${currentRoomId}/players/${currentUserId}`);
            set(userRef, {
                name: currentUserName,
                vote: null,
                voted: false,
                timestamp: Date.now()
            });

            // Listen for room state
            const roomRef = ref(database, `rooms/${currentRoomId}`);
            onValue(roomRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    updateUI(data);
                }
            });

            // Show game screen
            document.getElementById('setupScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'block';
            document.getElementById('currentRoom').textContent = currentRoomId;
            document.getElementById('currentUser').textContent = currentUserName;

            initializeCards();

            // Load recent emojis from localStorage
            loadRecentEmojis();

            // Start listening for emojis
            listenForEmojis();

            // Clean up on page unload
            window.addEventListener('beforeunload', () => {
                if (currentRoomId && currentUserId) {
                    const userRef = ref(database, `rooms/${currentRoomId}/players/${currentUserId}`);
                    remove(userRef);
                }
            });
        }

        // Select card
        function selectCard(value) {
            if (!currentRoomId || !currentUserId) return;

            // Update UI
            document.querySelectorAll('.card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`[data-value="${value}"]`).classList.add('selected');

            // Update database
            const userRef = ref(database, `rooms/${currentRoomId}/players/${currentUserId}`);
            update(userRef, {
                vote: value,
                voted: true
            });

            // Reset revealed state
            const roomRef = ref(database, `rooms/${currentRoomId}/revealed`);
            set(roomRef, false);
        }

        // Update UI with room data
        function updateUI(roomData) {
            const players = roomData.players || {};
            isRevealed = roomData.revealed || false;

            const playersList = document.getElementById('playersList');
            const playerCount = document.getElementById('playerCount');

            // Render poker table with players
            renderPokerTable(players);

            playersList.innerHTML = '';
            playerCount.textContent = Object.keys(players).length;

            const votes = [];

            Object.entries(players).forEach(([playerId, player]) => {
                const playerCard = document.createElement('div');
                playerCard.className = 'player-card';
                if (player.voted) {
                    playerCard.classList.add('voted');
                }

                const playerName = document.createElement('div');
                playerName.className = 'player-name';
                playerName.textContent = player.name;

                const playerVote = document.createElement('div');

                if (isRevealed && player.voted) {
                    playerVote.className = 'player-vote';
                    playerVote.textContent = player.vote;
                    if (player.vote !== null) {
                        votes.push(player.vote);
                    }
                } else if (player.voted) {
                    playerVote.className = 'vote-status';
                    playerVote.textContent = '‚úì Vot√≥';
                } else {
                    playerVote.className = 'vote-status';
                    playerVote.textContent = '‚è≥ Esperando...';
                }

                playerCard.appendChild(playerName);
                playerCard.appendChild(playerVote);
                playersList.appendChild(playerCard);
            });

            // Show statistics if revealed
            if (isRevealed && votes.length > 0) {
                showStatistics(votes);
            } else {
                document.getElementById('statistics').classList.remove('show');
            }
        }

        // Show statistics
        function showStatistics(votes) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = '';

            const average = (votes.reduce((a, b) => a + b, 0) / votes.length).toFixed(1);
            const min = Math.min(...votes);
            const max = Math.max(...votes);
            const median = calculateMedian(votes);

            const stats = [
                { label: 'Promedio', value: average },
                { label: 'M√≠nimo', value: min },
                { label: 'M√°ximo', value: max },
                { label: 'Mediana', value: median }
            ];

            stats.forEach(stat => {
                const statItem = document.createElement('div');
                statItem.className = 'stat-item';
                statItem.innerHTML = `
                    <div class="stat-label">${stat.label}</div>
                    <div class="stat-value">${stat.value}</div>
                `;
                statsGrid.appendChild(statItem);
            });

            document.getElementById('statistics').classList.add('show');
        }

        // Calculate median
        function calculateMedian(values) {
            const sorted = values.slice().sort((a, b) => a - b);
            const middle = Math.floor(sorted.length / 2);

            if (sorted.length % 2 === 0) {
                return ((sorted[middle - 1] + sorted[middle]) / 2).toFixed(1);
            } else {
                return sorted[middle];
            }
        }

        // Reveal votes
        function revealVotes() {
            if (!currentRoomId) return;

            const revealedRef = ref(database, `rooms/${currentRoomId}/revealed`);
            set(revealedRef, true);
        }

        // Reset votes
        function resetVotes() {
            if (!currentRoomId) return;

            const playersRef = ref(database, `rooms/${currentRoomId}/players`);
            onValue(playersRef, (snapshot) => {
                const players = snapshot.val();
                if (players) {
                    Object.keys(players).forEach(playerId => {
                        const userRef = ref(database, `rooms/${currentRoomId}/players/${playerId}`);
                        update(userRef, {
                            vote: null,
                            voted: false
                        });
                    });
                }
            }, { onlyOnce: true });

            const revealedRef = ref(database, `rooms/${currentRoomId}/revealed`);
            set(revealedRef, false);

            // Clear selected card
            document.querySelectorAll('.card').forEach(card => {
                card.classList.remove('selected');
            });
        }

        // Leave room
        function leaveRoom() {
            if (currentRoomId && currentUserId) {
                const userRef = ref(database, `rooms/${currentRoomId}/players/${currentUserId}`);
                remove(userRef);
            }

            currentRoomId = null;
            currentUserName = null;
            currentUserId = null;

            document.getElementById('setupScreen').style.display = 'flex';
            document.getElementById('gameScreen').style.display = 'none';
            document.getElementById('userName').value = '';
            document.getElementById('roomId').value = '';
        }
    </script>
</body>
</html>
